<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArticlesController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">team01</a> &gt; <a href="index.source.html" class="el_package">edu.ucsb.cs156.example.controllers</a> &gt; <span class="el_source">ArticlesController.java</span></div><h1>ArticlesController.java</h1><pre class="source lang-java linenums">package edu.ucsb.cs156.example.controllers;

import edu.ucsb.cs156.example.entities.Article;
import edu.ucsb.cs156.example.errors.EntityNotFoundException;
import edu.ucsb.cs156.example.repositories.ArticlesRepository;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.extern.slf4j.Slf4j;

import com.fasterxml.jackson.core.JsonProcessingException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.HttpStatus;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.server.ResponseStatusException;

import jakarta.validation.Valid;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.List;

/**
 * This is a REST controller for Articles
 */

@Tag(name = &quot;Articles&quot;)
@RequestMapping(&quot;/api/articles&quot;)
@RestController
<span class="fc" id="L42">@Slf4j</span>
<span class="fc" id="L43">public class ArticlesController extends ApiController {</span>

    @Autowired
    ArticlesRepository articlesRepository;

    /**
     * List all articles
     * 
     * @return an iterable of Articles
     */
    @Operation(summary= &quot;List all articles&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_USER')&quot;)
    @GetMapping(&quot;/all&quot;)
    public Iterable&lt;Article&gt; allArticles() {
<span class="fc" id="L57">        return articlesRepository.findAll();</span>
    }

    /**
     * Get a single article by id
     * 
     * @param id the id of the article
     * @return an Article
     */
    @Operation(summary= &quot;Get a single article&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_USER')&quot;)
    @GetMapping(&quot;&quot;)
    public Article getById(
            @Parameter(name=&quot;id&quot;) @RequestParam Long id) {
<span class="fc" id="L71">        Article article = articlesRepository.findById(id)</span>
<span class="fc" id="L72">                .orElseThrow(() -&gt; new EntityNotFoundException(Article.class, id));</span>

<span class="fc" id="L74">        return article;</span>
    }

    /**
     * Create a new article
     * 
     * @param title the title of the article
     * @param url the url of the article
     * @param explanation the explanation of the article
     * @param email the email of the person who added the article
     * @param dateAdded the date the article was added
     * @return the saved article
     */
    @Operation(summary= &quot;Create a new article&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_ADMIN')&quot;)
    @PostMapping(&quot;/post&quot;)
    public Article postArticle(
            @Parameter(name=&quot;title&quot;) @RequestParam String title,
            @Parameter(name=&quot;url&quot;) @RequestParam String url,
            @Parameter(name=&quot;explanation&quot;) @RequestParam String explanation,
            @Parameter(name=&quot;email&quot;) @RequestParam String email,
            @Parameter(name=&quot;dateAdded&quot;) @RequestParam String dateAdded)
            throws JsonProcessingException {

        LocalDateTime dateTime;
        try {
<span class="fc" id="L100">            dateTime = parseDateTime(dateAdded);</span>
<span class="fc" id="L101">        } catch (DateTimeParseException e) {</span>
<span class="fc" id="L102">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Invalid date format. Use ISO date format (YYYY-MM-DD) or ISO date-time format (YYYY-MM-DDThh:mm:ss)&quot;);</span>
<span class="fc" id="L103">        }</span>

<span class="fc" id="L105">        log.info(&quot;dateAdded={}&quot;, dateTime);</span>

<span class="fc" id="L107">        Article article = Article.builder()</span>
<span class="fc" id="L108">                .title(title)</span>
<span class="fc" id="L109">                .url(url)</span>
<span class="fc" id="L110">                .explanation(explanation)</span>
<span class="fc" id="L111">                .email(email)</span>
<span class="fc" id="L112">                .dateAdded(dateTime)</span>
<span class="fc" id="L113">                .build();</span>

<span class="fc" id="L115">        Article savedArticle = articlesRepository.save(article);</span>

<span class="fc" id="L117">        return savedArticle;</span>
    }

    /**
     * Delete an Article
     * 
     * @param id the id of the article to delete
     * @return a message indicating the article was deleted
     */
    @Operation(summary= &quot;Delete an Article&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_ADMIN')&quot;)
    @DeleteMapping(&quot;&quot;)
    public Object deleteArticle(
            @Parameter(name=&quot;id&quot;) @RequestParam Long id) {
<span class="fc" id="L131">        Article article = articlesRepository.findById(id)</span>
<span class="fc" id="L132">                .orElseThrow(() -&gt; new EntityNotFoundException(Article.class, id));</span>

<span class="fc" id="L134">        articlesRepository.delete(article);</span>
<span class="fc" id="L135">        return genericMessage(&quot;Article with id %s deleted&quot;.formatted(id));</span>
    }

    /**
     * Update a single article
     * 
     * @param id the id of the article to update
     * @param incoming the new article data
     * @return the updated article
     */
    @Operation(summary= &quot;Update a single article&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_ADMIN')&quot;)
    @PutMapping(&quot;&quot;)
    public Article updateArticle(
            @Parameter(name=&quot;id&quot;) @RequestParam Long id,
            @RequestBody @Valid Article incoming) {

<span class="fc" id="L152">        Article article = articlesRepository.findById(id)</span>
<span class="fc" id="L153">                .orElseThrow(() -&gt; new EntityNotFoundException(Article.class, id));</span>

<span class="fc" id="L155">        article.setTitle(incoming.getTitle());</span>
<span class="fc" id="L156">        article.setUrl(incoming.getUrl());</span>
<span class="fc" id="L157">        article.setExplanation(incoming.getExplanation());</span>
<span class="fc" id="L158">        article.setEmail(incoming.getEmail());</span>
<span class="fc" id="L159">        article.setDateAdded(incoming.getDateAdded());</span>

<span class="fc" id="L161">        articlesRepository.save(article);</span>

<span class="fc" id="L163">        return article;</span>
    }

    /**
     * Get articles within a date range
     * 
     * @param startDate the start date in ISO format (yyyy-MM-dd or yyyy-MM-ddTHH:mm:ss)
     * @param endDate the end date in ISO format (yyyy-MM-dd or yyyy-MM-ddTHH:mm:ss)
     * @return a list of Articles within the date range
     */
    @Operation(summary= &quot;Get articles within a date range&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_USER')&quot;)
    @GetMapping(&quot;/bydate&quot;)
    public List&lt;Article&gt; getArticlesByDateRange(
            @Parameter(name=&quot;startDate&quot;) @RequestParam String startDate,
            @Parameter(name=&quot;endDate&quot;) @RequestParam String endDate) {
        
        LocalDateTime start, end;
        try {
<span class="fc" id="L182">            start = parseDateTime(startDate);</span>
<span class="fc" id="L183">            end = parseDateTime(endDate);</span>
<span class="fc" id="L184">        } catch (DateTimeParseException e) {</span>
<span class="fc" id="L185">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Invalid date format. Use ISO date format (YYYY-MM-DD) or ISO date-time format (YYYY-MM-DDThh:mm:ss)&quot;);</span>
<span class="fc" id="L186">        }</span>
        
<span class="fc" id="L188">        return articlesRepository.findByDateAddedBetween(start, end);</span>
    }
    
    /**
     * Helper method to parse date strings in either date-only or date-time format
     */
    private LocalDateTime parseDateTime(String dateString) {
<span class="fc bfc" id="L195" title="All 2 branches covered.">        if (dateString.contains(&quot;T&quot;)) {</span>
            // Full date-time format
<span class="fc" id="L197">            return LocalDateTime.parse(dateString);</span>
        } else {
            // Date-only format, append T00:00:00 for midnight
<span class="fc" id="L200">            return LocalDateTime.parse(dateString + &quot;T00:00:00&quot;);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>